<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Мини RTS игра</title>
<style>
  body { background: #222; color: #eee; font-family: Arial, sans-serif; margin: 0; padding: 10px; }
  #game { display: flex; gap: 20px; }
  #map { background: #444; width: 600px; height: 400px; position: relative; overflow: hidden; border: 2px solid #666; }
  .building, .enemy, .bullet {
    position: absolute;
    border-radius: 5px;
  }
  .building {
    width: 60px; height: 60px; background: #88cc88; border: 2px solid #4a7f4a;
    display: flex; align-items: center; justify-content: center; font-weight: bold;
    color: #224422; user-select: none; cursor: pointer;
  }
  .building.oil { background: #ccaa33; border-color: #997700; color: #553300; }
  .building.tower { background: #cc5555; border-color: #772222; color: #440000; }
  .enemy {
    width: 40px; height: 40px; background: #cc4444; border: 2px solid #aa2222;
    display: flex; align-items: center; justify-content: center; font-weight: bold;
    color: #330000; user-select: none;
  }
  .bullet {
    width: 8px; height: 8px; background: yellow; border-radius: 50%;
  }
  #sidebar {
    width: 320px; background: #333; padding: 10px; border-radius: 5px;
  }
  button {
    margin: 5px 0; padding: 10px; width: 100%;
    font-size: 16px; font-weight: bold; cursor: pointer;
    border: none; border-radius: 5px;
  }
  button:hover { background: #555; color: #fff; }
  #info { margin-top: 10px; min-height: 40px; }
</style>
</head>
<body>

<h1>Мини RTS игра</h1>
<div id="game">
  <div id="map"></div>
  <div id="sidebar">
    <div><b>Ресурсы:</b></div>
    <div>Золото: <span id="gold">0</span></div>
    <div>Нефть: <span id="oil">0</span></div>
    <hr/>
    <div><b>Построить здание:</b></div>
    <button id="buildHouse">Построить Дом (100 золота)</button>
    <button id="buildOil">Построить Нефтяную скважину (150 золота)</button>
    <button id="buildTower">Построить Башню (200 золота)</button>
    <hr/>
    <div><b>Улучшения:</b></div>
    <button id="upgradeHouse">Улучшить Дом</button>
    <button id="upgradeOil">Улучшить Нефтяную скважину</button>
    <button id="upgradeTower">Улучшить Башню</button>
    <hr/>
    <div id="info"></div>
  </div>
</div>

<audio id="soundBuild" src="https://freesound.org/data/previews/66/66717_931655-lq.mp3"></audio>
<audio id="soundShoot" src="https://freesound.org/data/previews/256/256113_3263906-lq.mp3"></audio>
<audio id="soundEnemyDeath" src="https://freesound.org/data/previews/171/171508_2437358-lq.mp3"></audio>

<script>
(() => {
  // Игровые переменные
  let gold = 500;
  let oil = 0;
  const map = document.getElementById('map');
  const goldSpan = document.getElementById('gold');
  const oilSpan = document.getElementById('oil');
  const info = document.getElementById('info');
  const soundBuild = document.getElementById('soundBuild');
  const soundShoot = document.getElementById('soundShoot');
  const soundEnemyDeath = document.getElementById('soundEnemyDeath');

  // Объекты зданий
  const buildings = [];
  // Враги
  const enemies = [];
  // Пули
  const bullets = [];

  // Инфо про здания и улучшения
  const upgrades = {
    house: { level: 1, goldPerSec: 1, upgradeCost: 100, count: 0 },
    oil: { level: 1, oilPerSec: 1, upgradeCost: 120, count: 0 },
    tower: { level: 1, damage: 5, cooldown: 2000, upgradeCost: 150, count: 0 }
  };

  // Обновление ресурсов в интерфейсе
  function updateResources() {
    goldSpan.textContent = gold.toFixed(0);
    oilSpan.textContent = oil.toFixed(0);
  }

  // Добавляем здание
  function addBuilding(type) {
    const costMap = { house: 100, oil: 150, tower: 200 };
    if(gold < costMap[type]){
      info.textContent = 'Недостаточно золота!';
      return;
    }
    gold -= costMap[type];
    updateResources();

    const b = document.createElement('div');
    b.classList.add('building');
    b.classList.add(type);
    b.textContent = type === 'house' ? 'Дом' : type === 'oil' ? 'Нефть' : 'Башня';

    // Позиционирование случайное, чтобы не накладывались (простой вариант)
    let x, y, tries = 0;
    do {
      x = Math.random() * (map.clientWidth - 60);
      y = Math.random() * (map.clientHeight - 60);
      tries++;
    } while (checkCollision(x,y,60,60) && tries < 100);
    b.style.left = x + 'px';
    b.style.top = y + 'px';

    map.appendChild(b);

    buildings.push({
      type,
      elem: b,
      x,
      y,
      hp: 100 + (upgrades[type].level - 1) * 50,
      lastShoot: 0
    });

    upgrades[type].count++;
    info.textContent = `${type === 'house' ? 'Дом' : type === 'oil' ? 'Нефтяная скважина' : 'Башня'} построена!`;
    soundBuild.play();
  }

  // Проверка столкновений зданий, чтобы не ставить поверх
  function checkCollision(x, y, w, h) {
    for(const b of buildings){
      const bx = b.x, by = b.y;
      if(x < bx + 60 && x + w > bx && y < by + 60 && y + h > by){
        return true;
      }
    }
    return false;
  }

  // Улучшение здания
  function upgradeBuilding(type){
    if(upgrades[type].count === 0){
      info.textContent = `Нет построенных ${type === 'house' ? 'домов' : type === 'oil' ? 'нефтяных скважин' : 'башен'}`;
      return;
    }
    const cost = upgrades[type].upgradeCost;
    if(gold < cost){
      info.textContent = 'Недостаточно золота для улучшения!';
      return;
    }
    gold -= cost;
    upgrades[type].level++;
    upgrades[type].upgradeCost = Math.floor(cost * 1.7);
    // Улучшаем параметры зданий этого типа
    buildings.forEach(b => {
      if(b.type === type){
        if(type === 'house'){
          // Увеличиваем hp и goldPerSec (пассивный доход)
          b.hp += 50;
        } else if(type === 'oil'){
          b.hp += 40;
        } else if(type === 'tower'){
          b.hp += 30;
          upgrades.tower.damage++;
          upgrades.tower.cooldown = Math.max(500, upgrades.tower.cooldown - 150);
        }
      }
    });
    info.textContent = `${type === 'house' ? 'Дом' : type === 'oil' ? 'Нефтяная скважина' : 'Башня'} улучшен до уровня ${upgrades[type].level}`;
    updateResources();
  }

  // Генерация врагов с постепенным усилением
  function spawnEnemy(){
    const enemy = document.createElement('div');
    enemy.classList.add('enemy');
    enemy.textContent = 'Враг';

    // Спавн слева за пределами карты
    let y = Math.random() * (map.clientHeight - 40);
    enemy.style.left = '-50px';
    enemy.style.top = y + 'px';

    map.appendChild(enemy);

    enemies.push({
      elem: enemy,
      x: -50,
      y: y,
      hp: 20 + Math.floor(performance.now()/60000)*5, // Становятся сильнее со временем
      speed: 0.5 + Math.random()*0.5,
      target: null,
      attacking: false,
      attackCooldown: 0
    });
  }

  // Движение врагов к ближайшему зданию
  function enemyBehavior(enemy){
    if(enemy.hp <= 0){
      map.removeChild(enemy.elem);
      soundEnemyDeath.play();
      return false;
    }
    // Если нет цели — ищем ближайшее здание
    if(!enemy.target || enemy.target.hp <= 0){
      let nearest = null;
      let nearestDist = 1e9;
      for(const b of buildings){
        if(b.hp <= 0) continue;
        const dx = (b.x + 30) - enemy.x;
        const dy = (b.y + 30) - enemy.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < nearestDist){
          nearest = b;
          nearestDist = dist;
        }
      }
      enemy.target = nearest;
      enemy.attacking = false;
    }
    if(!enemy.target) return true; // Нет зданий — ждем

    const dx = (enemy.target.x + 30) - enemy.x;
    const dy = (enemy.target.y + 30) - enemy.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if(dist > 40){
      // Движемся к зданию
      enemy.x += (dx / dist) * enemy.speed;
      enemy.y += (dy / dist) * enemy.speed;
      enemy.elem.style.left = enemy.x + 'px';
      enemy.elem.style.top = enemy.y + 'px';
      enemy.attacking = false;
    } else {
      // Атакуем здание
      if(enemy.attackCooldown <= 0){
        enemy.target.hp -= 1 + Math.floor(Math.random()*3);
        if(enemy.target.hp <= 0){
          enemy.target.elem.style.background = '#333';
          enemy.target.elem.textContent = 'Разрушено';
        }
        enemy.attackCooldown = 1000;
      } else {
        enemy.attackCooldown -= 50;
      }
      enemy.attacking = true;
    }
    return true;
  }

  // Башни стреляют по врагам
  function towersShoot(){
    const now = performance.now();
    buildings.forEach(b => {
      if(b.type !== 'tower' || b.hp <= 0) return;
      if(!b.lastShoot) b.lastShoot = 0;
      if(now - b.lastShoot < upgrades.tower.cooldown) return;

      // Ищем ближайшего врага в радиусе 150
      let target = null;
      let nearestDist = 150;
      for(const e of enemies){
        if(e.hp <= 0) continue;
        const dx = (e.x + 20) - (b.x + 30);
        const dy = (e.y + 20) - (b.y + 30);
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < nearestDist){
          nearestDist = dist;
          target = e;
        }
      }
      if(target){
        // Создаем пулю
        createBullet(b.x + 30, b.y + 30, target);
        b.lastShoot = now;
        soundShoot.play();
      }
    });
  }

  // Создание пули и её движение
  function createBullet(x, y, target){
    const bullet = document.createElement('div');
    bullet.classList.add('bullet');
    bullet.style.left = x + 'px';
    bullet.style.top = y + 'px';
    map.appendChild(bullet);

    bullets.push({
      elem: bullet,
      x,
      y,
      target,
      speed: 6,
      alive: true
    });
  }

  // Обновление пуль
  function updateBullets(){
    bullets.forEach((b,i) => {
      if(!b.alive) return;

      const dx = (b.target.x + 20) - b.x;
      const dy = (b.target.y + 20) - b.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist < b.speed){
        // Попадание
        b.target.hp -= upgrades.tower.damage;
        if(b.target.hp <= 0){
          b.target.elem.style.background = '#333';
          b.target.elem.textContent = 'Разрушено';
          // Убиваем врага, если это враг? Нет, это здание
        }
        b.alive = false;
        map.removeChild(b.elem);
      } else {
        b.x += (dx / dist) * b.speed;
        b.y += (dy / dist) * b.speed;
        b.elem.style.left = b.x + 'px';
        b.elem.style.top = b.y + 'px';
      }
    });
    // Чистим мертвые пули
    for(let i=bullets.length-1; i>=0; i--){
      if(!bullets[i].alive){
        bullets.splice(i,1);
      }
    }
  }

  // Пассивный доход золота и нефти от зданий
  function passiveIncome(){
    buildings.forEach(b => {
      if(b.hp <= 0) return;
      if(b.type === 'house'){
        gold += upgrades.house.goldPerSec * 0.1;
      } else if(b.type === 'oil'){
        oil += upgrades.oil.oilPerSec * 0.1;
      }
    });
    updateResources();
  }

  // Основной игровой цикл
  function gameLoop(){
    // Враги
    for(let i = enemies.length - 1; i >= 0; i--){
      if(!enemyBehavior(enemies[i])){
        enemies.splice(i,1);
      }
    }

    // Башни стреляют
    towersShoot();

    // Пули летят
    updateBullets();

    // Пассивный доход
    passiveIncome();
  }

  // Спавн врагов каждые 5 секунд
  setInterval(spawnEnemy, 5000);

  // Цикл игры ~60fps
  setInterval(gameLoop, 50);

  // Кнопки управления
  document.getElementById('buildHouse').onclick = () => addBuilding('house');
  document.getElementById('buildOil').onclick = () => addBuilding('oil');
  document.getElementById('buildTower').onclick = () => addBuilding('tower');

  document.getElementById('upgradeHouse').onclick = () => upgradeBuilding('house');
  document.getElementById('upgradeOil').onclick = () => upgradeBuilding('oil');
  document.getElementById('upgradeTower').onclick = () => upgradeBuilding('tower');

  updateResources();
  info.textContent = 'Добро пожаловать! Постройте здания и защищайтесь от врагов.';
})();
</script>

</body>
</html>
