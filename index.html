<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Mini Clash Top-Down Improved</title>
<style>
  body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
    user-select: none;
  }
  #game {
    max-width: 720px;
    margin: 15px auto;
    background: #e3f2fd;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    padding: 15px;
  }
  #resources {
    display: flex;
    justify-content: space-around;
    font-weight: 700;
    font-size: 18px;
    margin-bottom: 10px;
  }
  #build-buttons {
    text-align: center;
    margin-bottom: 10px;
  }
  #build-buttons button {
    background: #4caf50;
    border: none;
    padding: 10px 15px;
    margin: 0 6px;
    border-radius: 8px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #build-buttons button:hover {
    background: #388e3c;
  }
  #map {
    position: relative;
    display: grid;
    grid-template-columns: repeat(12, 56px);
    grid-template-rows: repeat(8, 56px);
    gap: 6px;
    justify-content: center;
    background: #81c784;
    border-radius: 15px;
    padding: 8px;
  }
  .cell {
    position: relative;
    background: linear-gradient(145deg, #a5d6a7, #66bb6a);
    border-radius: 12px;
    box-shadow: inset 3px 3px 7px #5a9d4a,
                inset -3px -3px 5px #a4df8a;
    cursor: pointer;
    transition: transform 0.15s ease;
  }
  .cell:hover {
    transform: scale(1.05);
    box-shadow: 0 0 12px #66bb6a;
  }
  .building {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    animation: pulse 2s infinite alternate;
  }
  .building.house {
    background: linear-gradient(145deg, #ffd54f, #ffb300);
    border: 2px solid #ffca28;
  }
  .building.barracks {
    background: linear-gradient(145deg, #64b5f6, #1976d2);
    border: 2px solid #42a5f5;
  }
  .building.oilrig {
    background: linear-gradient(145deg, #4db6ac, #00796b);
    border: 2px solid #26a69a;
  }
  .building.tower {
    background: linear-gradient(145deg, #ef5350, #b71c1c);
    border: 2px solid #e53935;
  }
  @keyframes pulse {
    0% { box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    100% { box-shadow: 0 0 15px rgba(0,0,0,0.3); }
  }
  /* Юниты */
  .unit {
    position: absolute;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(145deg, #f44336, #d32f2f);
    box-shadow: 0 3px 5px rgba(0,0,0,0.4);
    animation: unit-walk 1s steps(4) infinite;
    pointer-events: none;
  }
  @keyframes unit-walk {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(0.85); }
  }
  /* Враги */
  .enemy {
    position: absolute;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(145deg, #6a1b9a, #4a148c);
    box-shadow: 0 3px 5px rgba(0,0,0,0.6);
    animation: enemy-walk 1.2s steps(4) infinite;
    pointer-events: none;
  }
  @keyframes enemy-walk {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(0.7); }
  }
  /* Снаряд башни */
  .projectile {
    position: absolute;
    width: 10px;
    height: 10px;
    background: #ff5252;
    border-radius: 50%;
    pointer-events: none;
  }
  #info {
    margin-top: 12px;
    text-align: center;
    font-weight: 600;
    min-height: 24px;
  }
</style>
</head>
<body>

<div id="game">
  <div id="resources">
    <div>Золото: <span id="gold">100</span></div>
    <div>Нефть: <span id="oil">50</span></div>
  </div>
  <div id="build-buttons">
    <button data-building="house">Дом (20 золота)</button>
    <button data-building="barracks">Казармы (50 золота)</button>
    <button data-building="oilrig">Нефтяная вышка (30 золота)</button>
    <button data-building="tower">Защитная башня (60 золота)</button>
    <button id="create-unit-btn" disabled>Создать юнита (10 золота)</button>
  </div>
  <div id="map"></div>
  <div id="info">Выберите здание для строительства</div>
</div>

<script>
  const mapWidth = 12;
  const mapHeight = 8;
  const map = document.getElementById('map');
  const goldSpan = document.getElementById('gold');
  const oilSpan = document.getElementById('oil');
  const info = document.getElementById('info');
  const createUnitBtn = document.getElementById('create-unit-btn');

  let gold = 100;
  let oil = 50;
  let selectedBuilding = null;
  let barracksCells = [];
  let towers = [];
  let units = [];
  let enemies = [];

  // Стоимость зданий
  const costs = {
    house: { gold: 20, oil: 0 },
    barracks: { gold: 50, oil: 0 },
    oilrig: { gold: 30, oil: 0 },
    tower: { gold: 60, oil: 0 },
    unit: { gold: 10 }
  };

  // Карта - массив клеток с объектами
  const cells = [];

  // Создаем сетку карты
  for(let y=0; y < mapHeight; y++){
    for(let x=0; x < mapWidth; x++){
      const cell = document.createElement('div');
      cell.classList.add('cell');
      cell.dataset.x = x;
      cell.dataset.y = y;
      map.appendChild(cell);
      cells.push(cell);
    }
  }

  // Обработчик кнопок строительства
  document.getElementById('build-buttons').addEventListener('click', e => {
    if(e.target.tagName !== 'BUTTON') return;

    if(e.target.id === 'create-unit-btn'){
      if(barracksCells.length === 0) {
        info.textContent = 'Нет казарм для создания юнитов.';
        return;
      }
      if(gold >= costs.unit.gold){
        gold -= costs.unit.gold;
        updateResources();
        createUnit();
      } else {
        info.textContent = 'Недостаточно золота для юнита';
      }
      return;
    }

    const building = e.target.dataset.building;
    if(building){
      if(gold >= costs[building].gold && oil >= costs[building].oil){
        selectedBuilding = building;
        info.textContent = `Выберите клетку для строительства ${building}`;
      } else {
        info.textContent = 'Недостаточно ресурсов для строительства';
      }
    }
  });

  // Клик по клетке - строим здание если выбрано
  map.addEventListener('click', e => {
    if(!selectedBuilding) return;

    const cell = e.target.closest('.cell');
    if(!cell) return;

    if(cell.hasChildNodes()){
      info.textContent = 'Клетка занята';
      return;
    }

    // Строим здание
    buildBuilding(cell, selectedBuilding);
    selectedBuilding = null;
    info.textContent = 'Здание построено';
  });

  // Обновление ресурсов на странице
  function updateResources(){
    goldSpan.textContent = gold;
    oilSpan.textContent = oil;

    // Включаем кнопку создания юнита, если есть казармы и достаточно золота
    createUnitBtn.disabled = barracksCells.length === 0 || gold < costs.unit.gold;
  }

  // Строим здание на клетке
  function buildBuilding(cell, building){
    // Снимаем ресурсы
    gold -= costs[building].gold;
    oil -= costs[building].oil;
    updateResources();

    // Создаем DOM элемент здания
    const b = document.createElement('div');
    b.classList.add('building', building);
    cell.appendChild(b);

    // Логика зданий
    if(building === 'house'){
      // Дом дает золото 1 каждую секунду
      if(!cell.goldInterval){
        cell.goldInterval = setInterval(() => {
          gold += 1;
          updateResources();
        }, 1000);
      }
    } else if(building === 'barracks'){
      barracksCells.push(cell);
    } else if(building === 'oilrig'){
      // Нефтяная вышка даёт 1 нефти каждые 5 секунд
      if(!cell.oilInterval){
        cell.oilInterval = setInterval(() => {
          oil += 1;
          updateResources();
        }, 5000);
      }
    } else if(building === 'tower'){
      // Добавляем в список башен для атаки врагов
      towers.push({cell: cell, element: b, cooldown: 0});
    }
  }

  // Создаем юнита из казарм - появится возле первой казармы
  function createUnit(){
    if(barracksCells.length === 0) return;
    const barracksCell = barracksCells[0];
    const unit = {
      x: parseInt(barracksCell.dataset.x),
      y: parseInt(barracksCell.dataset.y),
      hp: 10,
      speed: 0.1,
      element: document.createElement('div'),
      target: null,
      path: []
    };
    unit.element.classList.add('unit');
    unit.element.style.left = unit.x * 62 + 'px';
    unit.element.style.top = unit.y * 62 + 'px';
    map.appendChild(unit.element);
    units.push(unit);
  }

  // Обновление игры (движение юнитов, атаки башен, появление врагов)
  function gameLoop(){
    // Движение юнитов (просто случайное)
    units.forEach(u => {
      // Простейшее движение - случайное
      if(!u.target){
        u.target = {
          x: Math.floor(Math.random() * mapWidth),
          y: Math.floor(Math.random() * mapHeight)
        };
      }
      const dx = u.target.x - u.x;
      const dy = u.target.y - u.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist < 0.1){
        u.target = null;
      } else {
        u.x += (dx/dist) * u.speed;
        u.y += (dy/dist) * u.speed;
      }
      u.element.style.left = u.x * 62 + 'px';
      u.element.style.top = u.y * 62 + 'px';
    });

    // Башни атакуют врагов
    towers.forEach(tower => {
      if(tower.cooldown > 0){
        tower.cooldown -= 16;
        return;
      }
      // Находим ближайшего врага в радиусе 3 клеток
      const tx = parseInt(tower.cell.dataset.x);
      const ty = parseInt(tower.cell.dataset.y);

      let nearestEnemy = null;
      let nearestDist = 9999;
      enemies.forEach(e => {
        const ex = e.x;
        const ey = e.y;
        const d = Math.sqrt((tx - ex)**2 + (ty - ey)**2);
        if(d <= 3 && d < nearestDist){
          nearestEnemy = e;
          nearestDist = d;
        }
      });

      if(nearestEnemy){
        // Стреляем в врага - создаем снаряд
        shootProjectile(tower, nearestEnemy);
        tower.cooldown = 1000; // 1 секунда перезарядки
      }
    });

    // Движение врагов
    enemies.forEach(enemy => {
      if(enemy.hp <= 0){
        // Уничтожаем врага
        enemy.element.remove();
        enemies = enemies.filter(e => e !== enemy);
        gold += 5;
        updateResources();
        return;
      }

      // Двигаемся к случайной точке (или к казармам)
      if(!enemy.target){
        // Цель — ближайшая казарма, если есть
        if(barracksCells.length > 0){
          const barrack = barracksCells[0];
          enemy.target = {
            x: parseInt(barrack.dataset.x),
            y: parseInt(barrack.dataset.y)
          };
        } else {
          enemy.target = {
            x: Math.floor(Math.random() * mapWidth),
            y: Math.floor(Math.random() * mapHeight)
          };
        }
      }

      const dx = enemy.target.x - enemy.x;
      const dy = enemy.target.y - enemy.y;
      const dist = Math.sqrt(dx*dx + dy*dy);

      if(dist < 0.1){
        // Атака здания (если казарма)
        barracksCells.forEach(cell => {
          if(cell.dataset.x == enemy.x.toFixed(0) && cell.dataset.y == enemy.y.toFixed(0)){
            // Уничтожаем казарму
            cell.innerHTML = '';
            barracksCells = barracksCells.filter(c => c !== cell);
            gold -= 20; // штраф
            updateResources();
          }
        });
        enemy.target = null;
      } else {
        enemy.x += (dx/dist) * enemy.speed;
        enemy.y += (dy/dist) * enemy.speed;
        enemy.element.style.left = enemy.x * 62 + 'px';
        enemy.element.style.top = enemy.y * 62 + 'px';
      }
    });

    // Обновляем снаряды
    projectiles.forEach(proj => {
      proj.x += proj.vx;
      proj.y += proj.vy;
      proj.element.style.left = proj.x * 62 + 'px';
      proj.element.style.top = proj.y * 62 + 'px';

      // Проверка попадания во врага
      const hitEnemy = enemies.find(e => Math.abs(e.x - proj.x) < 0.3 && Math.abs(e.y - proj.y) < 0.3);
      if(hitEnemy){
        hitEnemy.hp -= proj.damage;
        proj.element.remove();
        projectiles = projectiles.filter(p => p !== proj);
      }

      // Если снаряд улетел за карту - удаляем
      if(proj.x < 0 || proj.x > mapWidth || proj.y < 0 || proj.y > mapHeight){
        proj.element.remove();
        projectiles = projectiles.filter(p => p !== proj);
      }
    });

    requestAnimationFrame(gameLoop);
  }

  // Снаряды башен
  let projectiles = [];
  function shootProjectile(tower, enemy){
    const tx = parseInt(tower.cell.dataset.x);
    const ty = parseInt(tower.cell.dataset.y);

    const proj = {
      x: tx,
      y: ty,
      damage: 3,
      element: document.createElement('div'),
      vx: 0,
      vy: 0
    };
    proj.element.classList.add('projectile');
    map.appendChild(proj.element);

    // Вектор скорости к врагу
    const dx = enemy.x - tx;
    const dy = enemy.y - ty;
    const dist = Math.sqrt(dx*dx + dy*dy);
    proj.vx = (dx / dist) * 0.3;
    proj.vy = (dy / dist) * 0.3;

    projectiles.push(proj);
  }

  // Спавн врагов каждые 10 секунд
  function spawnEnemy(){
    const enemy = {
      x: 0,
      y: 0,
      hp: 15,
      speed: 0.05,
      element: document.createElement('div'),
      target: null
    };
    enemy.element.classList.add('enemy');
    enemy.element.style.left = enemy.x * 62 + 'px';
    enemy.element.style.top = enemy.y * 62 + 'px';
    map.appendChild(enemy.element);
    enemies.push(enemy);
  }

  setInterval(spawnEnemy, 10000);

  updateResources();
  requestAnimationFrame(gameLoop);
</script>
</body>
</html>
