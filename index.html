<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Clash Base Prototype</title>
<style>
  body {
    margin: 0; background: #3b5a31; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #eee;
    user-select: none;
  }
  #top-bar {
    background: #2a3e1e;
    display: flex; justify-content: space-around; align-items: center;
    padding: 10px 0; font-weight: bold; font-size: 18px;
  }
  #top-bar div {
    display: flex; align-items: center;
  }
  #top-bar img {
    width: 24px; height: 24px; margin-right: 6px;
  }
  #main {
    display: flex; height: calc(100vh - 50px);
  }
  #base-container {
    background: #4a703d;
    width: 70vw;
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    grid-template-rows: repeat(8, 1fr);
    gap: 4px;
    padding: 10px;
    border: 3px solid #1f2d13;
    box-sizing: border-box;
    position: relative;
  }
  .tile {
    background: #567d3a;
    border-radius: 5px;
    border: 1px solid #3e5e20;
    cursor: pointer;
    position: relative;
    transition: background 0.3s;
  }
  .tile:hover {
    background: #6b8e44;
  }
  .building {
    width: 100%;
    height: 100%;
    border-radius: 5px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    position: absolute;
    top: 0; left: 0;
  }
  #sidebar {
    width: 30vw;
    background: #2a3e1e;
    display: flex;
    flex-direction: column;
    padding: 15px;
    box-sizing: border-box;
  }
  #sidebar h2 {
    margin: 0 0 10px 0;
    text-align: center;
  }
  button {
    background: #4a703d;
    border: none;
    border-radius: 6px;
    padding: 10px;
    color: #ddd;
    font-weight: bold;
    margin-bottom: 10px;
    cursor: pointer;
    transition: background 0.3s;
    width: 100%;
  }
  button:hover {
    background: #5b814a;
  }
  #units-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .unit {
    background: #3a5b25;
    border-radius: 6px;
    flex: 1 1 40%;
    padding: 10px;
    cursor: pointer;
    text-align: center;
  }
  .unit:hover {
    background: #4a6e31;
  }
  #battle-screen {
    position: fixed;
    top: 50px; left: 0; right: 0; bottom: 0;
    background: #202d12;
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 10px;
  }
  #battle-map {
    background: #395223;
    width: 90vw;
    height: 60vh;
    margin-bottom: 10px;
    position: relative;
    border-radius: 10px;
    box-shadow: 0 0 20px #2a3d11;
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    grid-template-rows: repeat(6, 1fr);
    gap: 3px;
  }
  .battle-tile {
    background: #4a703d;
    border-radius: 4px;
    border: 1px solid #335220;
    position: relative;
  }
  .battle-building {
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    width: 100%;
    height: 100%;
  }
  .battle-unit {
    position: absolute;
    width: 30px;
    height: 30px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    pointer-events: none;
    transition: all 0.3s;
  }
  #battle-log {
    height: 100px;
    width: 90vw;
    overflow-y: auto;
    background: #273b17;
    border-radius: 6px;
    padding: 10px;
    font-size: 14px;
  }
  #btn-exit-battle {
    background: #672525;
    width: 150px;
    margin-top: 10px;
  }
</style>
</head>
<body>

<div id="top-bar">
  <div><img src="https://img.icons8.com/ios-filled/50/ffd700/coin.png" alt="Gold" /> <span id="gold">1000</span></div>
  <div><img src="https://img.icons8.com/ios-filled/50/4a90e2/diamond.png" alt="Elixir" /> <span id="elixir">500</span></div>
  <div><img src="https://img.icons8.com/ios-filled/50/808080/rock.png" alt="Stone" /> <span id="stone">200</span></div>
</div>

<div id="main">
  <div id="base-container"></div>

  <div id="sidebar">
    <h2>Постройки</h2>
    <button id="build-hut">Построить Хижину (100 золота)</button>
    <button id="build-farm">Построить Ферму (150 золота)</button>
    <button id="build-barracks">Построить Казармы (300 золота)</button>

    <h2>Создать юнитов (Казармы)</h2>
    <div id="units-list">
      <div class="unit" data-unit="soldier">Солдат (50 золота)</div>
      <div class="unit" data-unit="archer">Лучник (70 золота)</div>
    </div>

    <button id="attack-btn" style="margin-top: 30px; background: #864444;">Атаковать другую базу</button>
  </div>
</div>

<div id="battle-screen">
  <h2>Бой с другой базой</h2>
  <div id="battle-map"></div>
  <div id="battle-log"></div>
  <button id="btn-exit-battle">Выйти из боя</button>
</div>

<script>
  // Игровые данные
  let resources = {
    gold: 1000,
    elixir: 500,
    stone: 200,
  };

  // Состояние базы - 10x8 клеток
  const baseWidth = 10;
  const baseHeight = 8;
  // Хранит здания на клетках {x,y: type, level}
  let baseBuildings = JSON.parse(localStorage.getItem('baseBuildings')) || {};

  // Хранилище юнитов, созданных игроком
  let army = JSON.parse(localStorage.getItem('army')) || [];

  // Временный массив юнитов в бою
  let battleUnits = [];

  // Постройки и цены
  const buildingData = {
    hut: {cost: 100, name: "Хижина", img: "https://img.icons8.com/ios-filled/50/ffffff/cabin.png", maxLevel: 3},
    farm: {cost: 150, name: "Ферма", img: "https://img.icons8.com/ios-filled/50/ffffff/field.png", maxLevel: 3},
    barracks: {cost: 300, name: "Казармы", img: "https://img.icons8.com/ios-filled/50/ffffff/barracks.png", maxLevel: 3}
  };

  // Юниты и цены
  const unitData = {
    soldier: {cost: 50, hp: 100, dmg: 20, img: "https://img.icons8.com/ios-filled/50/ffffff/soldier.png"},
    archer: {cost: 70, hp: 70, dmg: 30, img: "https://img.icons8.com/ios-filled/50/ffffff/archer.png"}
  };

  // DOM элементы
  const baseContainer = document.getElementById('base-container');
  const goldSpan = document.getElementById('gold');
  const elixirSpan = document.getElementById('elixir');
  const stoneSpan = document.getElementById('stone');

  // Обновить отображение ресурсов
  function updateResources() {
    goldSpan.textContent = resources.gold;
    elixirSpan.textContent = resources.elixir;
    stoneSpan.textContent = resources.stone;
  }

  // Создаём базу (сетка)
  function createBaseGrid() {
    baseContainer.innerHTML = '';
    for(let y=0; y<baseHeight; y++) {
      for(let x=0; x<baseWidth; x++) {
        const tile = document.createElement('div');
        tile.classList.add('tile');
        tile.dataset.x = x;
        tile.dataset.y = y;
        tile.addEventListener('click', () => onTileClick(x, y));
        baseContainer.appendChild(tile);

        // Если есть постройка на этой клетке, отобразим
        const key = `${x},${y}`;
        if(baseBuildings[key]) {
          placeBuildingOnTile(tile, baseBuildings[key]);
        }
      }
    }
  }

  // Отобразить здание на тайле
  function placeBuildingOnTile(tile, building) {
    let bdiv = document.createElement('div');
    bdiv.classList.add('building');
    bdiv.style.backgroundImage = `url(${buildingData[building.type].img})`;
    bdiv.title = buildingData[building.type].name + " Уровень: " + building.level;
    tile.appendChild(bdiv);
  }

  // Обработка клика по тайлу для улучшения здания
  function onTileClick(x, y) {
    const key = `${x},${y}`;
    if(baseBuildings[key]) {
      let b = baseBuildings[key];
      if(b.level < buildingData[b.type].maxLevel) {
        // Улучшить здание (цена = 50% от стоимости * уровень)
        let upgradeCost = Math.floor(buildingData[b.type].cost * 0.5 * b.level);
        if(resources.gold >= upgradeCost) {
          resources.gold -= upgradeCost;
          b.level++;
          saveGame();
          updateResources();
          createBaseGrid();
          alert(`${buildingData[b.type].name} улучшена до уровня ${b.level}!`);
        } else {
          alert("Недостаточно золота для улучшения!");
        }
      } else {
        alert("Максимальный уровень достигнут");
      }
    }
  }

  // Функция построить здание в свободной клетке (последняя кликнутая клетка или ближайшая)
  function buildBuilding(type) {
    if(resources.gold < buildingData[type].cost) {
      alert("Недостаточно золота для постройки!");
      return;
    }
    // Найдём первую свободную клетку (без здания)
    let found = false;
    outer: for(let y=0; y<baseHeight; y++) {
      for(let x=0; x<baseWidth; x++) {
        let key = `${x},${y}`;
        if(!baseBuildings[key]) {
          baseBuildings[key] = {type, level: 1};
          resources.gold -= buildingData[type].cost;
          found = true;
          break outer;
        }
      }
    }
    if(!found) {
      alert("Нет свободных клеток для строительства!");
      return;
    }
    saveGame();
    updateResources();
    createBaseGrid();
  }

  // Создать юнит
  function createUnit(type) {
    if(resources.gold < unitData[type].cost) {
      alert("Недостаточно золота для создания юнита!");
      return;
    }
    // Проверяем есть ли казармы (минимум 1 уровень)
    let barracksCount = Object.values(baseBuildings).filter(b => b.type === 'barracks').length;
    if(barracksCount === 0) {
      alert("Постройте казармы, чтобы создавать юнитов!");
      return;
    }
    resources.gold -= unitData[type].cost;
    army.push({type, hp: unitData[type].hp});
    saveGame();
    updateResources();
    alert(`Создан юнит: ${type}`);
  }

  // Сохранение в localStorage
  function saveGame() {
    localStorage.setItem('baseBuildings', JSON.stringify(baseBuildings));
    localStorage.setItem('army', JSON.stringify(army));
    localStorage.setItem('resources', JSON.stringify(resources));
  }

  // Загрузка ресурсов
  function loadResources() {
    const saved = JSON.parse(localStorage.getItem('resources'));
    if(saved) {
      resources = saved;
    }
  }

  // Начальная инициализация
  loadResources();
  updateResources();
  createBaseGrid();

  // Обработчики кнопок строительства
  document.getElementById('build-hut').addEventListener('click', () => buildBuilding('hut'));
  document.getElementById('build-farm').addEventListener('click', () => buildBuilding('farm'));
  document.getElementById('build-barracks').addEventListener('click', () => buildBuilding('barracks'));

  // Обработчики создания юнитов
  document.querySelectorAll('#units-list .unit').forEach(unitEl => {
    unitEl.addEventListener('click', () => {
      const unitType = unitEl.dataset.unit;
      createUnit(unitType);
    });
  });

  // Бой - экран
  const battleScreen = document.getElementById('battle-screen');
  const battleMap = document.getElementById('battle-map');
  const battleLog = document.getElementById('battle-log');
  const btnExitBattle = document.getElementById('btn-exit-battle');

  // Кнопка атаки
  document.getElementById('attack-btn').addEventListener('click', () => {
    if(army.length === 0) {
      alert("У вас нет юнитов для атаки!");
      return;
    }
    startBattle();
  });

  // Начать бой
  function startBattle() {
    battleScreen.style.display = 'flex';
    battleLog.innerHTML = "";
    battleUnits = army.map(u => ({...u, x: 0, y: 0, alive: true}));
    createBattleMap();
    battleStep();
  }

  // Создать карту боя (10x6)
  function createBattleMap() {
    battleMap.innerHTML = '';
    for(let y=0; y<6; y++) {
      for(let x=0; x<10; x++) {
        let tile = document.createElement('div');
        tile.classList.add('battle-tile');
        tile.dataset.x = x;
        tile.dataset.y = y;
        battleMap.appendChild(tile);
      }
    }
    // Добавим постройки противника
    // Противник - простой массив зданий в рандомных клетках
    battleEnemyBuildings = {
      "5,2": {type: 'hut', hp: 150},
      "6,3": {type: 'farm', hp: 200},
      "7,1": {type: 'barracks', hp: 300},
    };
    for(const key in battleEnemyBuildings) {
      const [x,y] = key.split(',').map(Number);
      let tile = [...battleMap.children].find(t => +t.dataset.x === x && +t.dataset.y === y);
      if(tile) {
        let bdiv = document.createElement('div');
        bdiv.classList.add('battle-building');
        bdiv.style.backgroundImage = `url(${buildingData[battleEnemyBuildings[key].type].img})`;
        bdiv.title = buildingData[battleEnemyBuildings[key].type].name + ' HP: ' + battleEnemyBuildings[key].hp;
        tile.appendChild(bdiv);
      }
    }
  }

  // Лог боя
  function addBattleLog(text) {
    battleLog.innerHTML += text + "<br/>";
    battleLog.scrollTop = battleLog.scrollHeight;
  }

  // Бой
